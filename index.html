<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Decizii medicale – Framing × Load</title>

  <!-- jsPsych LOCAL -->
  <script src="jspsych/jspsych.js"></script>
  <link rel="stylesheet" href="jspsych/jspsych.css" />

  <!-- Plugins LOCAL -->
  <script src="jspsych/plugin-html-keyboard-response.js"></script>
  <script src="jspsych/plugin-html-button-response.js"></script>
  <script src="jspsych/plugin-survey-text.js"></script>
  <script src="jspsych/plugin-survey-likert.js"></script>

  <style>
    body { background:#fff; }
    .wrap { max-width: 900px; margin: 0 auto; }
    .center { text-align:center; }
    .small { font-size:0.95rem; color:#444; }
    .muted { color:#666; }
    .pill { display:inline-block; padding:4px 10px; border:1px solid #ddd; border-radius:999px; margin-right:6px; }
    .scenario { line-height:1.45; }
  </style>
</head>
<body></body>

<script>
/* ===========================
   UTILITARE
=========================== */
function getUrlParam(name){
  return new URLSearchParams(window.location.search).get(name);
}
function randInt(min,max){
  return Math.floor(Math.random()*(max-min+1))+min;
}
function genDigits(n){
  let s="";
  for(let i=0;i<n;i++) s+=randInt(1,9);
  return s;
}
function normDigits(x){
  return String(x||"").replace(/\s+/g,"");
}

/* ===========================
   INIT jsPsych
=========================== */
const jsPsych = initJsPsych({
  on_finish: function(){
    const pid = jsPsych.data.get().values()[0]?.participant_id || "UNKNOWN";
    const ts = new Date().toISOString().replace(/[:.]/g,"-");
    jsPsych.data.get().localSave("csv", `data_${pid}_${ts}.csv`);
  }
});

const timeline = [];

/* ===========================
   CONDIȚII DIN URL
=========================== */
const form = getUrlParam("form");

const map = {
  "1": { risk:"high", load:"high" },
  "2": { risk:"high", load:"low"  },
  "3": { risk:"low",  load:"high" },
  "4": { risk:"low",  load:"low"  }
};

if(!map[form]){
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: "<p>Link invalid. Folosește linkul primit de la recruiter.</p>",
    choices:["Închide"]
  });
  jsPsych.run(timeline);
  throw "Bad link";
}

const risk_level = map[form].risk;
const load_condition = map[form].load;
const framing_condition = jsPsych.randomization.sampleWithoutReplacement(["gain","loss"],1)[0];

jsPsych.data.addProperties({
  form_id:Number(form),
  risk_level,
  load_condition,
  framing_condition
});

/* ===========================
   CONSIMȚĂMÂNT
=========================== */
timeline.push({
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <div class="wrap">
      <h3>Consimțământ informat</h3>
      <p class="small">Participi la un studiu de psihologie cognitivă despre decizii medicale ipotetice.</p>
      <p class="small muted">Durata: ~10–12 minute. Participarea este voluntară.</p>
    </div>
  `,
  choices:["Sunt de acord"]
});

/* ===========================
   ID PARTICIPANT
=========================== */
timeline.push({
  type: jsPsychSurveyText,
  questions:[{
    prompt:"Introdu ID-ul (ex: ST4_01):",
    name:"pid",
    required:true
  }],
  on_finish:function(data){
    const pid = data.response.pid.trim();
    if(!/^ST\d+_\d{2}$/.test(pid)){
      jsPsych.endExperiment("ID invalid. Reîncarcă pagina.");
      return;
    }
    jsPsych.data.addProperties({ participant_id: pid });
  }
});

/* ===========================
   INSTRUCȚIUNI
=========================== */
timeline.push({
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <div class="wrap">
      <p class="small">Vei parcurge 10 scenarii medicale.</p>
      <p class="small muted">
        <span class="pill">risc=${risk_level}</span>
        <span class="pill">load=${load_condition}</span>
        <span class="pill">framing=${framing_condition}</span>
      </p>
    </div>
  `,
  choices:["Începe"]
});

/* ===========================
   SCENARII
=========================== */
const N = 100;
const scenarios = [
  {id:1, title:"Oncologie", ctx:"Tratament pentru cancer agresiv",
   low:{safe:70,p:0.80}, high:{safe:35,p:0.45}},
  {id:2, title:"Chirurgie cardiacă", ctx:"Procedură standard vs inovatoare",
   low:{safe:60,p:0.70}, high:{safe:30,p:0.40}},
  {id:3, title:"ATI", ctx:"Protocol pentru pacienți critici",
   low:{safe:55,p:0.65}, high:{safe:25,p:0.30}},
  {id:4, title:"Infecție rezistentă", ctx:"Tratament antibiotic",
   low:{safe:50,p:0.60}, high:{safe:20,p:0.25}},
  {id:5, title:"Transplant", ctx:"Decizie pre-transplant",
   low:{safe:45,p:0.55}, high:{safe:22,p:0.28}},
  {id:6, title:"Prevenție", ctx:"Intervenție preventivă",
   low:{safe:65,p:0.75}, high:{safe:28,p:0.35}},
  {id:7, title:"Pediatrie", ctx:"Boală rară la copii",
   low:{safe:62,p:0.72}, high:{safe:26,p:0.32}},
  {id:8, title:"Neurologie", ctx:"Intervenție cu risc crescut",
   low:{safe:40,p:0.50}, high:{safe:18,p:0.20}},
  {id:9, title:"Epidemie", ctx:"Strategie comunitară",
   low:{safe:58,p:0.68}, high:{safe:32,p:0.42}},
  {id:10,title:"Psihiatrie", ctx:"Tratament cu efecte adverse",
   low:{safe:52,p:0.62}, high:{safe:24,p:0.29}}
];

function getParams(sc){
  return (risk_level==="high") ? sc.high : sc.low;
}
function digitsN(){
  return (load_condition==="high") ? 7 : 2;
}
function digitsDur(){
  return digitsN()*900 + 1500;
}

function scenarioHTML(sc){
  const p = getParams(sc);
  const pct = Math.round(p.p*100);
  const q = 100-pct;
  if(framing_condition==="gain"){
    return `
      <div class="wrap scenario">
        <h4>${sc.title}</h4>
        <p>${sc.ctx}</p>
        <p>Opțiunea sigură: <b>${p.safe}</b> salvați</p>
        <p>Opțiunea riscantă: <b>${pct}%</b> șanse să fie salvați <b>${N}</b></p>
      </div>`;
  } else {
    return `
      <div class="wrap scenario">
        <h4>${sc.title}</h4>
        <p>${sc.ctx}</p>
        <p>Opțiunea sigură: <b>${N-p.safe}</b> vor muri</p>
        <p>Opțiunea riscantă: <b>${pct}%</b> șanse ca nimeni să nu moară</p>
      </div>`;
  }
}

/* ===========================
   TRIALURI
=========================== */
jsPsych.randomization.shuffle(scenarios).forEach(sc=>{

  // DIGITS
  timeline.push({
    type: jsPsychHtmlKeyboardResponse,
    choices:"NO_KEYS",
    trial_duration: digitsDur,
    on_start:function(trial){
      const d = genDigits(digitsN());
      trial.stimulus = `<div class="center"><h2>${d.split("").join(" ")}</h2></div>`;
      trial.data = {task:"digits",scenario:sc.id,target:d};
    }
  });

  // FIXATION
  timeline.push({
    type: jsPsychHtmlKeyboardResponse,
    stimulus:"<h1>+</h1>",
    choices:"NO_KEYS",
    trial_duration:1200
  });

  // DECIZIE
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: scenarioHTML(sc),
    choices:["Sigură","Riscantă"],
    data:{task:"decision",scenario:sc.id},
    on_finish:d=>d.choice_risk=(d.response===1)?1:0
  });

  // RESPONSABILITATE
  timeline.push({
    type: jsPsychSurveyLikert,
    questions:[{
      prompt:"Cât de responsabil(ă) moral te simți?",
      labels:["1","2","3","4","5","6","7"]
    }],
    on_finish:d=>d.responsibility=Object.values(d.response)[0]+1
  });

  // RECALL
  timeline.push({
    type: jsPsychSurveyText,
    questions:[{prompt:"Introdu cifrele memorate:",name:"rec"}],
    on_start:function(trial){
      const last=jsPsych.data.get().filter({task:"digits"}).last(1).values()[0];
      trial.data.target=last.target;
    },
    on_finish:function(d){
      d.recall_correct = normDigits(d.response.rec)===normDigits(d.target)?1:0;
    }
  });
});

/* ===========================
   FINAL
=========================== */
timeline.push({
  type: jsPsychHtmlButtonResponse,
  stimulus:"<p>Mulțumim pentru participare!</p>",
  choices:["Finalizează"]
});

jsPsych.run(timeline);
</script>
</html>
