<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8">
  <title>Decizii medicale – framing & încărcare cognitivă</title>

  <!-- jsPsych core -->
  <script src="jspsych/jspsych.js"></script>
  <link href="jspsych/jspsych.css" rel="stylesheet">

  <!-- Plugins -->
  <script src="jspsych/plugin-html-button-response.js"></script>
  <script src="jspsych/plugin-html-keyboard-response.js"></script>
  <script src="jspsych/plugin-survey-text.js"></script>
  <script src="jspsych/plugin-survey-likert.js"></script>

</head>
<body></body>

<script>

  /* =====================
     INIT jsPsych
  ====================== */
  const jsPsych = initJsPsych({
    on_finish: function () {
      jsPsych.data.get().localSave('csv', 'data_' + jsPsych.data.get().values()[0].participant_id + '.csv');
    }
  });

  const timeline = [];

  /* =====================
     CONSIMȚĂMÂNT
  ====================== */
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: `
      <h3>Consimțământ informat</h3>
      <p>Participarea este voluntară. Experimentul durează ~10–12 minute și implică scenarii medicale ipotetice.</p>
      <p>Datele sunt anonime și utilizate exclusiv în scop academic.</p>
      <p>Apasă „Sunt de acord” pentru a continua.</p>
    `,
    choices: ["Sunt de acord"]
  });

  /* =====================
     ID PARTICIPANT
  ====================== */
  timeline.push({
    type: jsPsychSurveyText,
    questions: [
      {
        prompt: "Introdu ID-ul participantului (format: ST1_01, ST2_05 etc.)",
        name: "pid",
        required: true
      }
    ],
    button_label: "Continuă",
    on_finish: function (data) {

      let pid = "INVALID";

      if (data.response && typeof data.response === "object" && data.response.pid) {
        pid = String(data.response.pid).trim();
      }

      const valid = /^ST(10|[1-9])_\d{2}$/.test(pid);

      if (!valid) {
        jsPsych.endExperiment(`
          <p><b>ID invalid.</b></p>
          <p>Reîncarcă pagina și introdu un ID de forma <b>STx_yy</b> (ex: ST3_07).</p>
        `);
        return;
      }

      jsPsych.data.addProperties({ participant_id: pid });
    }
  });

  /* =====================
     INSTRUCȚIUNI
  ====================== */
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: `
      <p>Vei citi scenarii medicale și vei alege între două opțiuni.</p>
      <p>Uneori ți se va cere să memorezi un șir de cifre.</p>
      <p>Răspunde spontan și parcurge experimentul până la final.</p>
    `,
    choices: ["Începe"]
  });

  /* =====================
     EXEMPLU LOAD (LOW)
  ====================== */
  timeline.push({
    type: jsPsychHtmlKeyboardResponse,
    stimulus: "<p><b>Reține:</b> 4 9</p>",
    choices: "NO_KEYS",
    trial_duration: 2000,
    data: {
      load_condition: "low",
      digits_target: "49"
    }
  });

  timeline.push({
    type: jsPsychSurveyText,
    questions: [
      { prompt: "Introdu cifrele memorate:", name: "recall", required: true }
    ],
    on_finish: function (data) {
      const typed = data.response.recall.replace(/\s+/g, "");
      const target = data.digits_target;
      data.recall_correct = typed === target ? 1 : 0;
    }
  });

  /* =====================
     EXEMPLU SCENARIU
  ====================== */
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: `
      <p>Un tratament oferă <b>90% șanse de supraviețuire</b>.</p>
      <p>Alternativa implică un risc mai mare, dar un potențial beneficiu suplimentar.</p>
    `,
    choices: ["Aleg opțiunea sigură", "Aleg opțiunea riscantă"],
    data: {
      framing_condition: "gain",
      load_condition: "low",
      scenario_id: 1
    },
    on_finish: function (data) {
      data.choice_safe_risky = data.response === 1 ? 1 : 0;
    }
  });

  /* =====================
     RESPONSABILITATE MORALĂ
  ====================== */
  timeline.push({
    type: jsPsychSurveyLikert,
    questions: [
      {
        prompt: "Cât de responsabil(ă) moral te simți pentru decizia luată?",
        labels: ["1", "2", "3", "4", "5", "6", "7"],
        required: true
      }
    ],
    data: { task: "responsibility_rating" }
  });

  /* =====================
     FINAL
  ====================== */
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: "<p>Mulțumim pentru participare!</p>",
    choices: ["Finalizează"]
  });

  jsPsych.run(timeline);

</script>
</html>
