<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Decizii medicale – A/B (Framing × Load)</title>

  <!-- jsPsych LOCAL -->
  <script src="jspsych/jspsych.js"></script>
  <link rel="stylesheet" href="jspsych/jspsych.css" />

  <!-- Plugins LOCAL -->
  <script src="jspsych/plugin-html-keyboard-response.js"></script>
  <script src="jspsych/plugin-html-button-response.js"></script>
  <script src="jspsych/plugin-survey-text.js"></script>
  <script src="jspsych/plugin-survey-likert.js"></script>

  <style>
    body { background:#fff; }
    .wrap { max-width: 920px; margin: 0 auto; }
    .center { text-align:center; }
    .small { font-size:0.95rem; color:#444; }
    .muted { color:#666; }
    .pill { display:inline-block; padding:4px 10px; border:1px solid #ddd; border-radius:999px; margin-right:6px; }
    .scenario { line-height:1.5; }
    .hpad { padding: 10px 0; }
    h3,h4 { margin: 0.4rem 0; }
  </style>
</head>
<body></body>

<script>
/* ===========================
   UTILITARE
=========================== */
function getUrlParam(name){
  return new URLSearchParams(window.location.search).get(name);
}
function randInt(min,max){
  return Math.floor(Math.random()*(max-min+1))+min;
}
function genDigits(n){
  let s="";
  for(let i=0;i<n;i++) s+=randInt(1,9);
  return s;
}
function normDigits(x){
  return String(x||"").replace(/\s+/g,"");
}
function shuffleArray(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

/* ===========================
   INIT jsPsych
=========================== */
const jsPsych = initJsPsych({
  on_finish: function(){
    const pid = jsPsych.data.get().values()[0]?.participant_id || "UNKNOWN";
    const ts = new Date().toISOString().replace(/[:.]/g,"-");
    jsPsych.data.get().localSave("csv", `data_${pid}_${ts}.csv`);
  }
});

const timeline = [];

/* ===========================
   CONDIȚII DIN URL (4 LINKURI)
   ?form=1 high risk + high load
   ?form=2 high risk + low  load
   ?form=3 low  risk + high load
   ?form=4 low  risk + low  load
=========================== */
const form = getUrlParam("form");
const map = {
  "1": { risk:"high", load:"high" },
  "2": { risk:"high", load:"low"  },
  "3": { risk:"low",  load:"high" },
  "4": { risk:"low",  load:"low"  }
};

if(!map[form]){
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: `
      <div class="wrap">
        <h3>Link invalid</h3>
        <p class="small">Te rugăm să folosești linkul primit de la recruiter (cu <code>?form=1</code>, <code>?form=2</code>, <code>?form=3</code> sau <code>?form=4</code>).</p>
      </div>
    `,
    choices:["Închide"]
  });
  jsPsych.run(timeline);
  throw "Bad link";
}

const risk_level = map[form].risk;
const load_condition = map[form].load;

// framing random între participanți (gain/loss)
const framing_condition = jsPsych.randomization.sampleWithoutReplacement(["gain","loss"],1)[0];

jsPsych.data.addProperties({
  form_id: Number(form),
  risk_level,
  load_condition,
  framing_condition
});

/* ===========================
   CONSIMȚĂMÂNT
=========================== */
timeline.push({
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <div class="wrap">
      <h3>Consimțământ informat</h3>
      <p class="small">
        Participi la un studiu despre cum iau oamenii decizii când primesc informații medicale.
        Vei citi situații ipotetice și vei alege între două variante (A și B).
      </p>
      <p class="small muted">Durata: ~10–12 minute. Participarea este voluntară. Poți opri oricând.</p>
    </div>
  `,
  choices:["Sunt de acord"]
});

/* ===========================
   ID PARTICIPANT
=========================== */
timeline.push({
  type: jsPsychSurveyText,
  questions:[{
    prompt:"Introdu ID-ul (ex: ST4_01):",
    name:"pid",
    required:true
  }],
  button_label: "Continuă",
  on_finish:function(data){
    const pid = (data.response?.pid || "").trim();
    if(!/^ST(10|[1-9])_\d{2}$/.test(pid)){
      jsPsych.endExperiment(`
        <div class="wrap">
          <p><b>ID invalid.</b> Reîncarcă pagina și introdu un ID de forma <b>ST4_07</b>.</p>
        </div>
      `);
      return;
    }
    jsPsych.data.addProperties({ participant_id: pid });
  }
});

/* ===========================
   INSTRUCȚIUNI
=========================== */
timeline.push({
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <div class="wrap">
      <h3>Instrucțiuni</h3>
      <p class="small">
        Vei parcurge <b>10 situații</b>. Pentru fiecare:
        <br>1) Ții minte un șir de cifre (scurt)
        <br>2) Alegi între <b>Opțiunea A</b> și <b>Opțiunea B</b>
        <br>3) Spui cât de responsabil(ă) moral te simți pentru alegere
        <br>4) Reintroduci cifrele
      </p>
      <p class="small muted">
        Condiții (setate de link):
        <span class="pill">risc=${risk_level}</span>
        <span class="pill">load=${load_condition}</span>
        <span class="pill">framing=${framing_condition}</span>
      </p>
      <p class="small muted">Apasă „Începe”.</p>
    </div>
  `,
  choices:["Începe"]
});

/* ===========================
   SCENARII (10) cu variație de probabilități (anti-învățare)
=========================== */
const N = 100;

const scenarios = [
  {id:1,  title:"Oncologie", ctx:"E vorba de un tratament pentru un cancer agresiv.",
   low:{safe:70,p:0.80}, high:{safe:35,p:0.45}},
  {id:2,  title:"Chirurgie cardiacă", ctx:"E o procedură la inimă, cu două abordări posibile.",
   low:{safe:60,p:0.70}, high:{safe:30,p:0.40}},
  {id:3,  title:"Terapie intensivă", ctx:"Pacienții sunt în stare gravă, iar echipa decide protocolul.",
   low:{safe:55,p:0.65}, high:{safe:25,p:0.30}},
  {id:4,  title:"Infecție rezistentă", ctx:"Infecție greu de tratat; avem o variantă standard și una nouă.",
   low:{safe:50,p:0.60}, high:{safe:20,p:0.25}},
  {id:5,  title:"Transplant", ctx:"Decizie legată de un tratament înainte de transplant.",
   low:{safe:45,p:0.55}, high:{safe:22,p:0.28}},
  {id:6,  title:"Prevenție", ctx:"Program de prevenție pentru persoane cu risc crescut.",
   low:{safe:65,p:0.75}, high:{safe:28,p:0.35}},
  {id:7,  title:"Pediatrie", ctx:"Situație la copii, boală rară, două opțiuni de tratament.",
   low:{safe:62,p:0.72}, high:{safe:26,p:0.32}},
  {id:8,  title:"Neurologie", ctx:"Intervenție neurologică, o variantă mai sigură și una cu risc.",
   low:{safe:40,p:0.50}, high:{safe:18,p:0.20}},
  {id:9,  title:"Epidemie locală", ctx:"Măsuri pentru o comunitate, decizie cu risc și beneficii.",
   low:{safe:58,p:0.68}, high:{safe:32,p:0.42}},
  {id:10, title:"Efecte adverse", ctx:"Tratament cu potențial bun, dar și efecte adverse importante.",
   low:{safe:52,p:0.62}, high:{safe:24,p:0.29}}
];

function getParams(sc){
  return (risk_level === "high") ? sc.high : sc.low;
}

function digitsN(){
  return (load_condition === "high") ? 7 : 2;
}

// durată memorare: ~900ms/cifră + buffer
function digitsDur(){
  return digitsN()*900 + 1500; // low ~3300ms, high ~7800ms
}

/* ===========================
   TEXT „POPULAR” (medic → pacient)
   Construim două descrieri:
   - SAFE (determinist)
   - RISKY (probabilistic)
   Apoi le mapăm pe A/B aleator, pe fiecare scenariu.
=========================== */
function buildOptionTexts(sc){
  const prm = getParams(sc);
  const safe_saved = prm.safe;
  const p = Math.round(prm.p * 100);
  const q = 100 - p;

  let safeText = "";
  let riskyText = "";

  if(framing_condition === "gain"){
    safeText = `Dacă mergem pe varianta asta, ne putem aștepta să fie salvați cam <b>${safe_saved}</b> din <b>${N}</b> pacienți.`;
    riskyText = `Dacă alegem varianta asta, există <b>${p}%</b> șanse să fie salvați toți (<b>${N}</b>), dar și <b>${q}%</b> șanse să nu fie salvat niciunul (<b>0</b>).`;
  } else {
    const safe_die = N - safe_saved;
    safeText = `Dacă mergem pe varianta asta, ne putem aștepta să moară cam <b>${safe_die}</b> din <b>${N}</b> pacienți.`;
    riskyText = `Dacă alegem varianta asta, există <b>${p}%</b> șanse să nu moară nimeni (<b>0</b>), dar și <b>${q}%</b> șanse să moară toți (<b>${N}</b>).`;
  }

  return { safeText, riskyText, p_percent: p, safe_saved: safe_saved };
}

function scenarioPageHTML(sc, optionA, optionB){
  return `
    <div class="wrap scenario hpad">
      <div class="small muted">Situația ${sc.id}/10</div>
      <h3>${sc.title}</h3>
      <p class="small">Domnule/Doamnă, vă explic pe scurt: <b>${sc.ctx}</b></p>
      <p class="small">Gândiți-vă că sunt <b>${N}</b> pacienți în această situație.</p>

      <hr>

      <p class="small"><b>Opțiunea A:</b> ${optionA}</p>
      <p class="small"><b>Opțiunea B:</b> ${optionB}</p>

      <p class="small muted">Vă rog să alegeți varianta pe care ați merge.</p>
    </div>
  `;
}

/* ===========================
   TRIALURI (10 scenarii, ordine random)
=========================== */
const order = jsPsych.randomization.shuffle(scenarios.slice());

order.forEach(sc => {

  // (1) DIGITS PRESENT
  timeline.push({
    type: jsPsychHtmlKeyboardResponse,
    choices: "NO_KEYS",
    trial_duration: digitsDur,
    on_start: function(trial){
      const target = genDigits(digitsN());
      trial.stimulus = `
        <div class="wrap center">
          <p class="small muted">Ține minte cifrele (le vei scrie după ce alegi):</p>
          <h2 style="letter-spacing:2px;">${target.split("").join(" ")}</h2>
          <p class="small muted">Se va continua automat...</p>
        </div>
      `;
      trial.data = {
        task: "digits_present",
        scenario_id: sc.id,
        scenario_title: sc.title,
        digits_n: digitsN(),
        digits_target: target
      };
    }
  });

  // (1b) FIXATION / RETENTION
  timeline.push({
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `<div class="wrap center"><h1 style="font-size:52px;">+</h1></div>`,
    choices: "NO_KEYS",
    trial_duration: 1200,
    data: { task: "retention_fixation", scenario_id: sc.id }
  });

  // Prepare options A/B with variable mapping
  const texts = buildOptionTexts(sc);

  // Decide mapping (random per scenario)
  const safeIsA = jsPsych.randomization.sampleWithoutReplacement([0,1],1)[0] === 1;
  const optionA_text = safeIsA ? texts.safeText : texts.riskyText;
  const optionB_text = safeIsA ? texts.riskyText : texts.safeText;

  // (2) DECISION (A/B) with RT
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: scenarioPageHTML(sc, optionA_text, optionB_text),
    choices: ["Aleg Opțiunea A", "Aleg Opțiunea B"],
    data: {
      task: "decision",
      scenario_id: sc.id,
      scenario_title: sc.title,

      // experimental conditions (repeat per row for easy analysis)
      form_id: Number(form),
      risk_level: risk_level,
      load_condition: load_condition,
      framing_condition: framing_condition,

      // mapping info (critical!)
      safe_is_A: safeIsA ? 1 : 0,
      optionA_type: safeIsA ? "safe" : "risky",
      optionB_type: safeIsA ? "risky" : "safe",

      // scenario params (useful covariates)
      safe_saved: texts.safe_saved,
      risky_success_prob: texts.p_percent
    },
    on_finish: function(d){
      d.choice_button = d.response;            // 0=A, 1=B
      d.choice_label = (d.response === 0) ? "A" : "B";

      // derive: chosen_safe / chosen_risky
      const choseA = (d.response === 0);
      const chosenType = choseA ? (d.safe_is_A ? "safe" : "risky")
                                : (d.safe_is_A ? "risky" : "safe");
      d.chosen_type = chosenType;
      d.chose_risky = (chosenType === "risky") ? 1 : 0;
      d.chose_safe  = (chosenType === "safe")  ? 1 : 0;
    }
  });

  // (3) RESPONSIBILITY (Likert 1–7)
  timeline.push({
    type: jsPsychSurveyLikert,
    questions: [{
      prompt: "Cât de responsabil(ă) moral te simți pentru alegerea făcută?",
      labels: ["1","2","3","4","5","6","7"],
      required: true
    }],
    data: {
      task: "responsibility",
      scenario_id: sc.id,
      scenario_title: sc.title,
      form_id: Number(form),
      risk_level,
      load_condition,
      framing_condition,
      safe_is_A: safeIsA ? 1 : 0
    },
    on_finish: function(d){
      const v = Object.values(d.response)[0]; // 0..6
      d.responsibility = Number(v) + 1;       // 1..7
    }
  });

  // (4) DIGITS RECALL
  timeline.push({
    type: jsPsychSurveyText,
    questions: [{
      prompt: "Scrie cifrele pe care le-ai ținut minte (poți pune și spații):",
      name: "rec",
      required: true
    }],
    button_label: "Continuă",
    data: {
      task: "digits_recall",
      scenario_id: sc.id,
      scenario_title: sc.title,
      form_id: Number(form),
      risk_level,
      load_condition,
      framing_condition
    },
    on_start: function(trial){
      const last = jsPsych.data.get()
        .filter({task:"digits_present", scenario_id: sc.id})
        .last(1).values()[0];
      trial.data.digits_target = last?.digits_target || "";
      trial.data.digits_n = last?.digits_n || digitsN();
    },
    on_finish: function(d){
      const typed = normDigits(d.response?.rec || "");
      const target = normDigits(d.digits_target || "");
      d.digits_typed = typed;
      d.recall_correct = (typed === target) ? 1 : 0;
    }
  });

});

/* ===========================
   FINAL / DEBRIEF
=========================== */
timeline.push({
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <div class="wrap">
      <h3>Mulțumim!</h3>
      <p class="small">
        Situațiile au fost ipotetice. Studiul urmărește cum prezentarea informației (formularea în termeni de câștig/pierdere)
        și încărcarea cognitivă pot influența alegerile și responsabilitatea percepută.
      </p>
      <p class="small muted">După „Finalizează”, se va descărca automat un fișier CSV.</p>
    </div>
  `,
  choices: ["Finalizează"]
});

jsPsych.run(timeline);
</script>
</html>
