<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Încărcare cognitivă × Framing în decizii medicale riscante</title>

  <!-- jsPsych core (local) -->
  <script src="jspsych/jspsych.js"></script>
  <link href="jspsych/jspsych.css" rel="stylesheet" />

  <!-- Plugins (local) -->
  <script src="jspsych/plugin-html-button-response.js"></script>
  <script src="jspsych/plugin-html-keyboard-response.js"></script>
  <script src="jspsych/plugin-survey-text.js"></script>
  <script src="jspsych/plugin-survey-likert.js"></script>

  <style>
    body { background: #fff; }
    .wrap { max-width: 860px; margin: 0 auto; text-align: left; }
    .small { font-size: 0.95rem; color: #333; }
    .muted { color: #666; }
    .center { text-align: center; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:0.9rem; }
    .mt { margin-top: 12px; }
    .mb { margin-bottom: 12px; }
    .scenario { line-height: 1.4; }
  </style>
</head>
<body></body>

<script>
/* =========================================================
   0) UTILITARE
========================================================= */

// detect mobil (nu e perfect, dar ok pentru log)
function isMobile() {
  return /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
}

// random int
function randInt(min, max) { // inclusive
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

// generează șir cifre (fără 0 la început ca să fie mai ușor de introdus)
function genDigits(n) {
  let s = "";
  for (let i = 0; i < n; i++) s += String(randInt(1, 9));
  return s;
}

// normalizează cifre introduse (scoate spații)
function normDigits(x) {
  return String(x || "").replace(/\s+/g, "");
}

// helper: escape HTML (pentru numere/texte)
function esc(s){ return String(s).replace(/[&<>"']/g, m => ({
  "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
}[m])); }

/* =========================================================
   1) INIT jsPsych (salvare CSV la final)
========================================================= */

const jsPsych = initJsPsych({
  on_finish: function () {
    const pid = jsPsych.data.get().values()[0]?.participant_id || "UNKNOWN";
    const ts = new Date().toISOString().replace(/[:.]/g, "-");
    jsPsych.data.get().localSave("csv", `data_${pid}_${ts}.csv`);
  }
});

const timeline = [];

/* =========================================================
   2) CONSIMȚĂMÂNT
========================================================= */

timeline.push({
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <div class="wrap">
      <h3>Consimțământ informat</h3>
      <p class="small">
        Ești invitat(ă) să participi la un studiu de psihologie cognitivă despre luarea deciziilor în contexte medicale ipotetice.
        Participarea este <b>voluntară</b> și durează aproximativ <b>10–12 minute</b>.
      </p>
      <p class="small">
        Sarcina implică citirea unor scenarii medicale fictive, luarea unor decizii și răspunsuri scurte.
        Uneori vei memora temporar un șir de cifre.
      </p>
      <p class="small">
        Nu colectăm date de identificare personală. Datele sunt anonime și utilizate exclusiv în scop academic.
        Poți întrerupe oricând fără consecințe.
      </p>
      <p class="small muted">Apasă „Sunt de acord” pentru a continua.</p>
    </div>
  `,
  choices: ["Sunt de acord"]
});

/* =========================================================
   3) ID PARTICIPANT (format STx_yy)
========================================================= */

timeline.push({
  type: jsPsychSurveyText,
  questions: [{
    prompt: "Introdu ID-ul participantului (format: ST1_01, ST2_05, …, ST10_20).",
    name: "pid",
    required: true
  }],
  button_label: "Continuă",
  on_finish: function(data){
    let pid = "INVALID";
    if (data.response && typeof data.response === "object" && data.response.pid) {
      pid = String(data.response.pid).trim();
    }

    // validare: ST1_01 … ST10_99 (două cifre după underscore)
    const valid = /^ST(10|[1-9])_\d{2}$/.test(pid);

    if (!valid) {
      jsPsych.endExperiment(`
        <div class="wrap">
          <p><b>ID invalid.</b></p>
          <p>Reîncarcă pagina și introdu un ID de forma <b>STx_yy</b> (ex: <b>ST3_07</b>).</p>
        </div>
      `);
      return;
    }

    jsPsych.data.addProperties({
      participant_id: pid,
      device_mobile: isMobile() ? 1 : 0
    });
  }
});

/* =========================================================
   4) RANDOMIZARE BETWEEN-SUBJECTS 2×2
      framing: gain vs loss
      load: low vs high
========================================================= */

const framing_condition = jsPsych.randomization.sampleWithoutReplacement(["gain", "loss"], 1)[0];
const load_condition    = jsPsych.randomization.sampleWithoutReplacement(["low", "high"], 1)[0];

jsPsych.data.addProperties({
  framing_condition: framing_condition,
  load_condition: load_condition
});

/* =========================================================
   5) INSTRUCȚIUNI
========================================================= */

timeline.push({
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <div class="wrap">
      <h3>Instrucțiuni</h3>
      <p class="small">
        Vei parcurge <b>10 scenarii medicale</b> și vei alege între o opțiune <b>sigură</b> și una <b>riscantă</b>.
        În unele momente ți se va cere să <b>memorezi un șir de cifre</b> și să îl reintroduci ulterior.
      </p>
      <p class="small">
        Răspunde cât mai <b>spontan</b>. Nu există răspunsuri corecte/greșite la decizie.
      </p>
      <p class="small muted">
        Condiții: <span class="pill">framing = ${esc(framing_condition)}</span>
        <span class="pill">load = ${esc(load_condition)}</span>
        <br>(Aceste etichete nu vor fi arătate participanților reali; le poți scoate înainte de colectarea mare.)
      </p>
    </div>
  `,
  choices: ["Începe"]
});

/* =========================================================
   6) BANCA DE 10 SCENARII (aceeași structură numerică)
      Fiecare scenariu are:
      - context
      - N persoane afectate (ex 100)
      - Program sigur: salvați X / mor Y
      - Program riscant: p% salvați toți / p% salvați 0
========================================================= */

const scenarios = [
  { id: 1,  title: "Oncologie", context: "Un spital decide un plan de tratament pentru un grup de pacienți cu cancer agresiv." },
  { id: 2,  title: "Chirurgie cardiacă", context: "O echipă medicală decide între o procedură standard și una inovatoare pentru pacienți cu risc." },
  { id: 3,  title: "Terapie intensivă", context: "În ATI, trebuie ales un protocol de intervenție pentru pacienți cu complicații severe." },
  { id: 4,  title: "Antibiotic rezistent", context: "Există o infecție rezistentă la tratament și se decide între schema standard și una experimentală." },
  { id: 5,  title: "Transplant", context: "Se evaluează o opțiune de intervenție pentru pacienți aflați pe lista de transplant." },
  { id: 6,  title: "Vaccinare preventivă", context: "Se decide un program de intervenție preventivă pentru o populație expusă riscului." },
  { id: 7,  title: "Tratament pediatric", context: "Se alege între două opțiuni terapeutice pentru un grup de copii cu o boală rară." },
  { id: 8,  title: "Neurologie", context: "Se decide între o intervenție standard și una cu risc înalt pentru un grup de pacienți neurologici." },
  { id: 9,  title: "Epidemie locală", context: "Într-o comunitate apare o epidemie; se alege o strategie de intervenție." },
  { id: 10, title: "Terapie psihiatrică cu efecte adverse", context: "Se decide între un tratament conservator și unul cu potențial mare, dar și efecte adverse." }
];

// Parametri standard (poți schimba dacă vrei mai multă varietate)
const N_total = 100;
const safe_saved = 30;     // sigur: salvezi 30 / pierzi 70
const risky_prob = 0.30;   // riscant: 30% salvezi 100 / 70% salvezi 0

function stimulusForScenario(sc, framing) {
  const p = Math.round(risky_prob * 100);
  const q = 100 - p;

  if (framing === "gain") {
    return `
      <div class="wrap scenario">
        <div class="pill mb">${esc(sc.title)}</div>
        <p><b>Context:</b> ${esc(sc.context)}</p>
        <p>Se estimează că sunt afectați <b>${N_total}</b> pacienți.</p>
        <p><b>Opțiunea sigură:</b> vor fi salvați <b>${safe_saved}</b> pacienți.</p>
        <p><b>Opțiunea riscantă:</b> există <b>${p}%</b> șanse ca <b>${N_total}</b> pacienți să fie salvați și <b>${q}%</b> șanse ca <b>0</b> pacienți să fie salvați.</p>
        <p class="muted small mt">Alege opțiunea pe care o consideri mai potrivită.</p>
      </div>
    `;
  } else { // loss
    const safe_die = N_total - safe_saved; // 70
    return `
      <div class="wrap scenario">
        <div class="pill mb">${esc(sc.title)}</div>
        <p><b>Context:</b> ${esc(sc.context)}</p>
        <p>Se estimează că sunt afectați <b>${N_total}</b> pacienți.</p>
        <p><b>Opțiunea sigură:</b> vor muri <b>${safe_die}</b> pacienți.</p>
        <p><b>Opțiunea riscantă:</b> există <b>${p}%</b> șanse ca <b>0</b> pacienți să moară și <b>${q}%</b> șanse ca <b>${N_total}</b> pacienți să moară.</p>
        <p class="muted small mt">Alege opțiunea pe care o consideri mai potrivită.</p>
      </div>
    `;
  }
}

/* =========================================================
   7) CONSTRUIRE TRIALURI (LOAD + DECIZIE + RESPONSABILITATE + RECALL)
      - load_condition determină digits_n
      - 10 scenarii în ordine random per participant
========================================================= */

const digits_n = (load_condition === "high") ? 7 : 2;

// randomizează ordinea scenariilor
const scenario_order = jsPsych.randomization.shuffle(scenarios.slice());

scenario_order.forEach((sc, idx) => {

  // 7.1) Prezentare cifre (memorare)
  timeline.push({
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
      <div class="wrap center">
        <p class="small muted">Memorează cifrele (le vei introduce după decizie)</p>
        <h2 style="letter-spacing:2px;">${genDigits(digits_n).split("").join(" ")}</h2>
        <p class="small muted">Se va continua automat...</p>
      </div>
    `,
    choices: "NO_KEYS",
    trial_duration: 2000,
    on_start: function(trial){
      // generează și „închide” șirul în trial, ca să-l avem la recall
      const target = genDigits(digits_n);
      trial.stimulus = `
        <div class="wrap center">
          <p class="small muted">Memorează cifrele (le vei introduce după decizie)</p>
          <h2 style="letter-spacing:2px;">${target.split("").join(" ")}</h2>
          <p class="small muted">Se va continua automat...</p>
        </div>
      `;
      trial.data = {
        task: "digits_present",
        scenario_id: sc.id,
        domain: "medical",
        digits_n: digits_n,
        digits_target: target
      };
    }
  });

  // 7.2) Decizia (RT se salvează automat în data.rt)
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: stimulusForScenario(sc, framing_condition),
    choices: ["Aleg opțiunea sigură", "Aleg opțiunea riscantă"],
    data: {
      task: "decision",
      scenario_id: sc.id,
      domain: "medical"
    },
    on_finish: function(data){
      data.choice_safe_risky = (data.response === 1) ? 1 : 0;
      // păstrăm framing/load pe rând, deși există și în properties
      data.framing_condition = framing_condition;
      data.load_condition = load_condition;
    }
  });

  // 7.3) Responsabilitate morală (1 item; poți face 3 itemi dacă vrei)
  timeline.push({
    type: jsPsychSurveyLikert,
    questions: [{
      prompt: "Cât de responsabil(ă) moral te simți pentru decizia pe care ai luat-o?",
      labels: ["1", "2", "3", "4", "5", "6", "7"],
      required: true
    }],
    data: {
      task: "responsibility_rating",
      scenario_id: sc.id,
      domain: "medical"
    },
    on_finish: function(data){
      // extragem numeric robust (primul număr găsit)
      // jsPsych survey-likert pune adesea răspunsul ca obiect: {Q0: n}
      let val = NA;
      if (data.response && typeof data.response === "object") {
        const firstKey = Object.keys(data.response)[0];
        val = data.response[firstKey];
      }
      data.responsibility = Number(val);
      data.framing_condition = framing_condition;
      data.load_condition = load_condition;
    }
  });

  // 7.4) Recall cifre (manipulation check)
  timeline.push({
    type: jsPsychSurveyText,
    questions: [{
      prompt: "Introdu cifrele memorate (fără alte caractere):",
      name: "recall",
      required: true
    }],
    button_label: "Continuă",
    data: {
      task: "digits_recall",
      scenario_id: sc.id,
      domain: "medical"
    },
    on_start: function(trial){
      // găsim digits_target din ultimul trial „digits_present”
      const lastDigits = jsPsych.data.get().filter({task:"digits_present", scenario_id: sc.id}).last(1).values()[0];
      trial.data.digits_target = lastDigits?.digits_target || "";
      trial.data.digits_n = digits_n;
    },
    on_finish: function(data){
      let typedRaw = "";
      if (data.response && typeof data.response === "object" && data.response.recall != null) {
        typedRaw = String(data.response.recall);
      }
      const typed = normDigits(typedRaw);
      const target = normDigits(data.digits_target);

      data.digits_typed = typed;
      data.recall_correct = (typed === target) ? 1 : 0;
      data.framing_condition = framing_condition;
      data.load_condition = load_condition;
    }
  });

});

/* =========================================================
   8) DEBRIEF + FINAL
========================================================= */

timeline.push({
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <div class="wrap">
      <h3>Final</h3>
      <p class="small">
        Îți mulțumim pentru participare! Scenariile au fost ipotetice.
        Scopul studiului este să înțelegem cum formularea informației (câștig vs. pierdere)
        și încărcarea cognitivă influențează deciziile riscante și responsabilitatea percepută.
      </p>
      <p class="small muted">
        La apăsarea butonului „Finalizează”, se va descărca automat un fișier CSV cu datele tale.
      </p>
    </div>
  `,
  choices: ["Finalizează"]
});

jsPsych.run(timeline);

</script>
</html>
